<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Add Expense | Expense Tracker</title>
<style>
    body { font-family:"Segoe UI", sans-serif; margin:0; padding:0; background:#f3f4f6; }
    header { background:#4f46e5; color:white; padding:16px; display:flex; justify-content:space-between; align-items:center; }
    header h2 { margin:0; }
    header button { padding:8px 16px; background:#4338ca; border:none; color:white; border-radius:6px; cursor:pointer; }
    header button:hover { background:#3730a3; }

    /* Top navigation bar for dashboard pages */
    nav { background:#3730a3; display:flex; gap:12px; padding:8px 16px; }
    nav a { color:white; text-decoration:none; font-weight:600; padding:6px 12px; border-radius:6px; transition: background 0.2s; }
    nav a:hover { background:#4f46e5; }

    main { padding:24px; max-width:600px; margin:0 auto; }
    .form-group { margin-bottom:16px; display:flex; flex-direction:column; }
    .form-group label { font-weight:600; margin-bottom:6px; }
    .form-group input, .form-group select, .form-group textarea { padding:8px 10px; border-radius:6px; border:1px solid #d1d5db; font-size:14px; width:100%; }
    .form-group textarea { height:60px; resize:none; } /* Reduced comment field height */

    button { padding:10px 16px; border:none; border-radius:8px; cursor:pointer; font-weight:600; margin-right:10px; transition: background 0.2s; }
    #addExpenseBtn { background:#4f46e5; color:white; }
    #addExpenseBtn:hover { background:#4338ca; }
    #resetBtn { background:#e5e7eb; color:#111827; }
    #resetBtn:hover { background:#d1d5db; }

    .message-box { padding:10px; border-radius:6px; margin-bottom:16px; display:none; text-align:center; }
    .message-box.error { background:#fee2e2; color:#b91c1c; }
    .message-box.success { background:#d1fae5; color:#065f46; }
</style>
</head>
<body>

<header>
    <h2>Expense-IT !! <br> Welcome, <span id="username"></span> !</h2>
    <button id="logoutBtn">Logout</button>
</header>

<nav>
    <a href="dashboard1.html">View Current Expenses</a>
    <a href="dashboard2.html">Add a New Expense</a>
    <a href="dashboard3.html">Add a New Expense Category</a>
    <a href="dashboard4.html">Expense Analytics and Visualization</a>
    <a href="profile.html">Profile Page Update</a>
</nav>

<main>
    <div id="messageBox" class="message-box"></div>

    <div class="form-group">
        <label for="expenseName">Expense Name *</label>
        <select id="expenseName"></select>
    </div>

    <div class="form-group">
        <label for="expenseDate">Expense Date *</label>
        <input type="date" id="expenseDate">
    </div>

    <div class="form-group">
        <label for="expenseComment">Comment</label>
        <textarea id="expenseComment" placeholder="Optional"></textarea>
    </div>

    <div class="form-group">
        <label for="usdAmount">Amount (USD) *</label>
        <input type="number" id="usdAmount" step="0.01" min="0">
    </div>

    <div>
        <button id="addExpenseBtn">Add the Expense</button>
        <button id="resetBtn">Reset</button>
    </div>
</main>

<script>
const customer_id = localStorage.getItem("customer_id");
const username = localStorage.getItem("username") || "User";

if(!customer_id) window.location.href="index.html";

const msgBox = document.getElementById("messageBox");
const expenseName = document.getElementById("expenseName");
const expenseDate = document.getElementById("expenseDate");
const expenseComment = document.getElementById("expenseComment");
const usdAmount = document.getElementById("usdAmount");

document.getElementById("logoutBtn").addEventListener("click", ()=> {
    localStorage.removeItem("customer_id");
    localStorage.removeItem("username");
    window.location.href="index.html";
});

function showMessage(msg, type="success") {
    msgBox.className = `message-box ${type}`;
    msgBox.textContent = msg;
    msgBox.style.display = "block";
    setTimeout(() => { msgBox.style.display = "none"; }, 2500);
}

// ---------------------------
// Set today's date as default
// ---------------------------
const today = new Date().toISOString().split("T")[0];
expenseDate.value = today;
expenseDate.max = today;

// ---------------------------
// Fetch expense categories
// ---------------------------
async function fetchCategories() {
    try {
        const res = await fetch("http://localhost:3000/dashboard/categories", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ customer_id })
        });
        const data = await res.json();
        if(data.success){
            expenseName.innerHTML = `<option value="">Select Expense</option>`;
            data.categories.forEach(cat => {
                const opt = document.createElement("option");
                opt.value = cat.expense_name;
                opt.textContent = cat.expense_name;
                expenseName.appendChild(opt);
            });
        } else showMessage(data.message, "error");
    } catch(err) {
        showMessage("Error fetching categories","error");
        console.error(err);
    }
}

// ---------------------------
// Add expense
// ---------------------------
document.getElementById("addExpenseBtn").addEventListener("click", async () => {
    const name = expenseName.value;
    const date = expenseDate.value;
    const comment = expenseComment.value.trim();
    const amount = parseFloat(usdAmount.value);

    if(!name || !date || isNaN(amount) || amount <= 0) {
        return showMessage("Please fill all mandatory fields correctly", "error");
    }

    try {
        const res = await fetch("http://localhost:3000/dashboard/add_expense", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ customer_id, expense_name: name, expense_date: date, expense_comment: comment, usd_amount: amount })
        });
        const data = await res.json();
        if(data.success){
            showMessage(data.message, "success");
            // Reset fields for next entry
            expenseName.value = "";
            expenseDate.value = today;
            expenseComment.value = "";
            usdAmount.value = "";
        } else {
            showMessage(data.message || "Failed to add expense", "error");
        }
    } catch(err) {
        showMessage("Network error: Could not reach server","error");
        console.error(err);
    }
});

// ---------------------------
// Reset form
// ---------------------------
document.getElementById("resetBtn").addEventListener("click", () => {
    expenseName.value = "";
    expenseDate.value = today;
    expenseComment.value = "";
    usdAmount.value = "";
});

// ---------------------------
// Initialize page
// ---------------------------
document.getElementById("username").textContent = username;
fetchCategories();
</script>

</body>
</html>
